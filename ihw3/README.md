# Задача о сельской библиотеке

Многопроцессное приложение для моделирования работы библиотеки с использованием семафоров POSIX.

## Описание

Приложение моделирует работу библиотеки, в которой:
- Имеется N книг, каждая в одном экземпляре
- M читателей регулярно заглядывают в библиотеку, выбирая для чтения от 1 до 3 книг
- Читатели читают книги некоторое количество дней
- Если желаемой книги нет, читатель ждет информации от библиотекаря о ее появлении
- Несколько читателей могут конкурировать за популярную книгу
- Несколько наблюдателей отслеживают все события в библиотеке

## Архитектура

Приложение состоит из независимых процессов:

1. **librarian** - процесс библиотекаря, управляет книгами и информирует о доступности
2. **reader** - процесс читателя, запрашивает и читает книги
3. **observer** - процесс наблюдателя, получает и отображает все события

## Механизмы синхронизации

- **Именованные POSIX семафоры**: один семафор на каждую книгу для синхронизации доступа
- **Разделяемая память POSIX**: для хранения состояния библиотеки (книги, статусы, статистика)
- **Именованные каналы (FIFO)**: отдельный FIFO для каждого наблюдателя, все сообщения отправляются во все FIFO для поддержки множественных наблюдателей

## Компиляция

```bash
make
```

Очистка:
```bash
make clean
make clean-all 
```

## Запуск

### Вариант 1: Автоматический запуск (рекомендуется)

```bash
chmod +x run_library.sh cleanup.sh
./run_library.sh <num_books> <num_readers> <num_observers>
```

Пример:
```bash
./run_library.sh 10 5 2
```

Это запустит библиотеку с 10 книгами, 5 читателями и 2 наблюдателями. Наблюдатели откроются в отдельных окнах xterm.

### Вариант 2: Ручной запуск в разных терминалах

**Терминал 1 - Библиотекарь:**
```bash
./librarian 10
```

**Терминал 2 - Наблюдатель 1:**
```bash
./observer 1
```

**Терминал 3 - Наблюдатель 2:**
```bash
./observer 2
```

**Терминал 4+ - Читатели:**
```bash
./reader 1 10
./reader 2 10
./reader 3 10
```

Параметры:
- `librarian <num_books>` - количество книг в библиотеке
- `reader <reader_id> <num_books>` - идентификатор читателя и количество книг
- `observer [observer_id]` - идентификатор наблюдателя (опционально, по умолчанию 1)

## Завершение работы

- Нажмите `Ctrl+C` в любом процессе для корректного завершения
- Все процессы автоматически очищают системные ресурсы при завершении
- Для принудительной очистки используйте `./cleanup.sh`

## Требования

- ОС Linux
- GCC компилятор
- POSIX семафоры (обычно доступны в Linux по умолчанию)
- xterm (для автоматического запуска наблюдателей в отдельных окнах)

## Структура файлов

```
ihw3/
├── common.h          # Общие определения и структуры данных
├── common.c          # Реализация общих функций
├── librarian.c       # Программа библиотекаря
├── reader.c          # Программа читателя
├── observer.c        # Программа наблюдателя
├── Makefile          # Сборочный файл
├── run_library.sh    # Скрипт автоматического запуска
├── cleanup.sh        # Скрипт очистки ресурсов
└── README.md         # Документация
```

## Особенности реализации

1. **Корректное завершение**: Все процессы обрабатывают сигналы SIGINT и SIGTERM
2. **Очистка ресурсов**: Автоматическое удаление семафоров, разделяемой памяти и FIFO
3. **Множественные наблюдатели**: Поддержка нескольких наблюдателей через именованный канал
4. **Синхронизация**: Использование именованных POSIX семафоров для критических секций
5. **Наглядность**: Вывод временных меток и подробной информации о всех событиях

## Пример вывода

```
[БИБЛИОТЕКАРЬ 12345] Запуск библиотеки с 10 книгами
[14:30:15] [БИБЛИОТЕКАРЬ] Библиотека открыта. Книг: 10
[14:30:16] [ЧИТАТЕЛЬ 1] Пришел в библиотеку
[14:30:16] [ЧИТАТЕЛЬ 1] Хочет прочитать 2 книг
[14:30:17] [ЧИТАТЕЛЬ 1] Взял книгу 3
[14:30:18] [ЧИТАТЕЛЬ 1] Взял книгу 7
...
```

